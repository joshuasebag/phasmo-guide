<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <title>PHASMO-TRACKER Ultimate</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üëª</text></svg>">
  
  <meta name="google-site-verification" content="JgHSgqTfww6oZH2IdNMV8B5l6QsDQdTVgnMvWqpjd08" />
  
  <meta name="description" content="Le tracker ultime pour Phasmophobia. Identifiez les fant√¥mes, testez leur vitesse et consultez les guides. Compatible PC et Mobile." />
  <meta name="author" content="Sebag Joshua & Logeais Ma√©lann" />
  <meta name="theme-color" content="#0f172a">

  <style>
    :root {
      --bg: #0f172a; --panel: #1e293b; --accent: #2dd4bf; --text: #f1f5f9;
      --border: #334155; --danger: #ef4444; --success: #10b981; --warn: #f59e0b; --purple: #a855f7;
      --nav-height: 60px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* === LAYOUT GLOBAL === */
    .app-layout { display: flex; height: 100%; width: 100%; overflow: hidden; }
    
    /* SIDEBAR (PC) / CONTROLS (MOBILE) */
    .controls-area {
      background: #020617; border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      z-index: 20;
    }

    /* MAIN CONTENT */
    .main-area { flex: 1; overflow-y: auto; padding: 15px; position: relative; scroll-behavior: smooth; }

    /* === RESPONSIVE LOGIC === */
    /* MODE PC (> 900px) */
    @media (min-width: 900px) {
      .controls-area { width: 320px; padding: 20px; overflow-y: auto; }
      .mobile-nav, .mobile-proof-bar { display: none !important; }
      .pc-header { display: block; margin-bottom: 20px; font-size: 1.2rem; font-weight: 900; color: var(--accent); }
      .nav-pills { display: flex; gap: 5px; margin-bottom: 15px; background: #1e293b; padding: 5px; border-radius: 8px; }
      .nav-item { flex: 1; padding: 8px; border: none; background: transparent; color: #94a3b8; cursor: pointer; font-weight: bold; border-radius: 6px; }
      .nav-item.active { background: var(--accent); color: #000; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; }
    }

    /* MODE MOBILE (< 900px) */
    @media (max-width: 899px) {
      .app-layout { flex-direction: column; }
      .controls-area { display: none; } /* On cache la grosse sidebar sur mobile */
      .pc-header { display: none; }
      
      /* Navigation du bas */
      .mobile-nav {
        position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height);
        background: #0f172a; border-top: 1px solid var(--border);
        display: flex; justify-content: space-around; align-items: center;
        z-index: 100; padding-bottom: env(safe-area-inset-bottom);
      }
      .mn-item { background: none; border: none; color: #64748b; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 4px; font-weight: bold; width: 100%; padding: 8px 0; }
      .mn-item.active { color: var(--accent); }
      .mn-icon { font-size: 1.2rem; }

      /* Barre de Preuves Sticky en haut */
      .mobile-proof-bar {
        position: sticky; top: 0; z-index: 50;
        background: rgba(15,23,42, 0.95); backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        padding: 8px; display: flex; gap: 8px; overflow-x: auto;
        white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none;
      }
      .mobile-proof-bar::-webkit-scrollbar { display: none; }
      
      .main-area { padding-bottom: 80px; } /* Espace pour le menu du bas */
      .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    }

    /* === COMPOSANTS COMMUNS === */
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    
    /* PREUVES BUTTONS */
    .proof-btn {
      flex: 0 0 auto;
      padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px;
      background: #1e293b; color: #cbd5e1; font-weight: bold; font-size: 0.85rem;
      cursor: pointer; transition: 0.2s; user-select: none;
    }
    .proof-btn[data-state="inc"] { background: var(--success); color: #000; border-color: var(--success); }
    .proof-btn[data-state="exc"] { background: var(--danger); color: #fff; border-color: var(--danger); text-decoration: line-through; opacity: 0.7; }

    /* FANT√îMES */
    .ghost { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; position: relative; transition: 0.2s; }
    .ghost.excluded { display: none; } /* Cache les exclus */
    .ghost.manual-excluded { opacity: 0.4; order: 10; display: block; filter: grayscale(1); border-style: dashed; }
    .ghost.candidate { border-color: var(--accent); order: 1; box-shadow: 0 0 10px rgba(45,212,191,0.1); }
    
    .g-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .g-name { font-size: 1.2rem; font-weight: 900; color: white; }
    .g-meta { font-size: 0.8rem; color: #94a3b8; display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
    .g-actions { display: flex; gap: 8px; margin-top: 8px; }
    
    .btn-action { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: #0f172a; color: #cbd5e1; font-weight: bold; font-size: 0.8rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; }
    .btn-action.active { background: var(--accent); color: black; animation: pulse 1s infinite; border-color: var(--accent); }
    
    /* TIMER & CONTROLS */
    .timer-display { font-family: monospace; font-size: 2rem; color: var(--warn); text-align: center; background: #000; border-radius: 8px; padding: 5px; margin-bottom: 10px; border: 1px solid var(--border); }
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    
    /* BADGES */
    .badge { font-size: 0.7rem; padding: 2px 6px; background: #000; border-radius: 4px; color: #64748b; border: 1px solid #333; }
    .badge.match { color: var(--success); border-color: var(--success); }

    /* UTILS */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .search-input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid var(--accent); color: white; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; }

    /* ANIMATION */
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    /* MAPS & GUIDES */
    .guide-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .guide-table td, .guide-table th { padding: 8px; border-bottom: 1px solid #333; text-align: left; color: #e2e8f0; }
    .val-fast { color: var(--danger); font-weight: bold; }
    .val-slow { color: var(--purple); font-weight: bold; }
  </style>
</head>
<body>

<div class="mobile-proof-bar" id="mobile-proofs"></div>

<div class="app-layout">
  
  <aside class="controls-area">
    <div class="pc-header">PHASMO ULTIMATE üëª</div>
    
    <div class="nav-pills">
      <button class="nav-item active" onclick="setTab('tracker')">JOURNAL</button>
      <button class="nav-item" onclick="setTab('tools')">OUTILS</button>
      <button class="nav-item" onclick="setTab('guides')">GUIDES</button>
    </div>

    <div id="pc-proofs-list" style="display: flex; flex-direction: column; gap: 5px;"></div>
    
    <div style="margin-top: 20px; text-align: center; font-size: 0.8rem; color: #64748b; border-top: 1px solid #333; padding-top: 10px;">
      Dev: <span style="color:var(--accent)">Sebag Joshua</span> & <span style="color:var(--accent)">Logeais Ma√©lann</span>
    </div>
  </aside>

  <main class="main-area" id="main-content">
    
    <div id="view-tracker">
      <input type="text" class="search-input" placeholder="üîç Chercher (ex: Deogen...)" oninput="setSearch(this.value)">
      <div id="ghost-grid" class="grid"></div>
    </div>

    <div id="view-tools" class="hidden">
      
      <div class="card">
        <h4 style="margin:0 0 10px 0; color:var(--accent)">CHRONO ‚è±Ô∏è</h4>
        <div class="timer-display" id="timer-disp">00:00</div>
        <div class="btn-grid">
          <button class="btn-action" onclick="runTimer(90)">90s</button>
          <button class="btn-action" onclick="runTimer(180)">180s</button>
          <button class="btn-action" style="grid-column: span 2; border-color:var(--danger); color:var(--danger)" onclick="stopTimer()">STOP</button>
        </div>
      </div>

      <div class="card">
        <h4 style="margin:0 0 10px 0; color:var(--accent)">M√âTRONOME üîä</h4>
        <div class="btn-grid">
          <button class="btn-action metro-btn" onclick="startMetronome(1.0, this)">üê¢ 1.0 (Lent)</button>
          <button class="btn-action metro-btn" onclick="startMetronome(1.7, this)">üö∂ 1.7 (Norm)</button>
          <button class="btn-action metro-btn" onclick="startMetronome(2.5, this)">üêá 2.5 (Vite)</button>
          <button class="btn-action metro-btn" onclick="stopMetronome()">üõë STOP</button>
        </div>
        <button class="btn-action" style="width:100%; margin-top:5px" onmousedown="tapBpm()">üë£ TAPOTER RYTHME</button>
        <div id="bpm-val" class="text-center" style="margin-top:5px; font-weight:bold; color:#cbd5e1">--</div>
      </div>

      <div class="card">
        <h4 style="margin:0 0 10px 0; color:var(--accent)">OBJETS MAUDITS üó∫Ô∏è</h4>
        <select class="search-input" onchange="loadLocs(this.value)">
          <option value="">-- CHOISIR UNE CARTE --</option>
          <option value="tanglewood">6 Tanglewood Drive</option>
          <option value="willow">Willow Street</option>
          <option value="edgefield">42 Edgefield Road</option>
          <option value="ridgeview">10 Ridgeview Court</option>
          <option value="grafton">Grafton Farmhouse</option>
          <option value="bleasdale">Bleasdale Farmhouse</option>
          <option value="woodwind">Camp Woodwind</option>
          <option value="prison">Prison</option>
          <option value="sunny">Sunny Meadows</option>
        </select>
        <div id="loc-area"></div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between;"><span>üß† Sant√© Mentale</span><span id="san-disp" style="color:var(--accent)">100%</span></div>
        <input type="range" style="width:100%" min="0" max="100" value="100" oninput="setSan(this.value)">
      </div>
    </div>

    <div id="view-guides" class="hidden">
      <div class="card">
        <h4 style="color:var(--accent); margin-top:0">üêá VITESSES SP√âCIALES</h4>
        <table class="guide-table">
          <tr><td>Rev (Vu)</td><td class="val-fast">3.0 m/s</td></tr>
          <tr><td>Rev (Cach√©)</td><td class="val-slow">1.0 m/s</td></tr>
          <tr><td>Deogen (Loin)</td><td class="val-fast">3.0 m/s</td></tr>
          <tr><td>Deogen (Pr√®s)</td><td class="val-slow">0.4 m/s</td></tr>
          <tr><td>Hantu (Froid)</td><td class="val-fast">2.7 m/s</td></tr>
          <tr><td>Moroi (0% San)</td><td class="val-fast">2.25 m/s</td></tr>
          <tr><td>Thaye (Jeune)</td><td class="val-fast">2.75 m/s</td></tr>
        </table>
      </div>
      <div class="card">
        <h4 style="color:var(--accent); margin-top:0">üß© OUIJA (Co√ªt Sanit√©)</h4>
        <table class="guide-table">
          <tr><td>O√π √™tes-vous ?</td><td class="val-fast">-50%</td></tr>
          <tr><td>Quel √¢ge ?</td><td class="val-slow">-5%</td></tr>
          <tr><td>Quelle est votre pi√®ce ?</td><td class="val-fast">-50%</td></tr>
          <tr><td>O√π est l'os ?</td><td class="val-fast">-50%</td></tr>
          <tr><td>Cache-cache !</td><td class="val-fast">-25% + CHASSE</td></tr>
        </table>
      </div>
      <div class="card">
        <h4 style="color:var(--accent); margin-top:0">‚úã PATTE DE SINGE</h4>
        <table class="guide-table">
          <tr><td>Je souhaite voir le fant√¥me</td><td>Event + Aveugle</td></tr>
          <tr><td>Je souhaite revivre</td><td>50% chance</td></tr>
          <tr><td>Je souhaite partir</td><td>D√©verrouille portes (Lent)</td></tr>
          <tr><td>Je souhaite √™tre sain</td><td>Sant√© 50% (mais drain rapide)</td></tr>
        </table>
      </div>
    </div>

  </main>
</div>

<nav class="mobile-nav">
  <button class="mn-item active" onclick="setTab('tracker', this)"><span class="mn-icon">üìì</span>Journal</button>
  <button class="mn-item" onclick="setTab('tools', this)"><span class="mn-icon">üß∞</span>Outils</button>
  <button class="mn-item" onclick="setTab('guides', this)"><span class="mn-icon">üìñ</span>Guides</button>
  <button class="mn-item" style="color:var(--danger)" onclick="resetAll()"><span class="mn-icon">üóëÔ∏è</span>Reset</button>
</nav>

<script>
/* === DATA COMPL√àTE === */
const PROOFS = [
  { id:'emf', label:'EMF 5' }, { id:'orb', label:'Orbe' }, { id:'box', label:'Box' },
  { id:'frz', label:'Froid' }, { id:'uv', label:'UV' }, { id:'dot', label:'DOTS' }, { id:'wrt', label:'Ecrit' }
];

const GHOSTS = [
  { n:'Esprit', p:['emf','box','wrt'], th:50, sp:'1.7', t:'<b style="color:#2dd4bf">Test Encens:</b> Ne chasse pas pendant <b>180s</b> apr√®s encens (les autres c\'est 90s).' },
  { n:'Spectre', p:['dot','emf','box'], th:50, sp:'1.7', t:'<b style="color:#2dd4bf">Test Sel:</b> Ne marche <b>JAMAIS</b> dans le sel. Se TP sur un joueur (EMF 2/5).' },
  { n:'Fant√¥me', p:['dot','uv','box'], th:50, sp:'1.7', t:'<b style="color:#2dd4bf">Test Photo:</b> La photo intitul√©e "Fant√¥me" est <b>VIDE</b> (pas de glitch/perso). Clignote lent en chasse.' },
  { n:'Poltergeist', p:['uv','box','wrt'], th:50, sp:'1.7', t:'<b style="color:#2dd4bf">Test Objets:</b> Jette plein d\'objets tr√®s fort. Faire une pile d\'objets.' },
  { n:'Banshee', p:['dot','orb','uv'], th:50, sp:'1.7', t:'‚ôÄÔ∏è <b>FEMME uniquement.</b> <b style="color:#2dd4bf">Test Cible:</b> Ne tue que sa cible. Cri unique au micro parabolique.' },
  { n:'Djinn', p:['emf','uv','frz'], th:50, sp:'2.5', t:'‚ö° <b style="color:#2dd4bf">Courant:</b> Ne peut <b>JAMAIS</b> couper le disjoncteur (car il en a besoin). Rapide de loin.' },
  { n:'Cauchemar', p:['orb','box','wrt'], th:60, sp:'1.7', t:'‚ö° <b style="color:#2dd4bf">Courant:</b> Coupe tr√®s souvent le disjoncteur et les lumi√®res (veut le noir). Ne peut pas allumer.' },
  { n:'Revenant', p:['orb','wrt','frz'], th:50, sp:'3.0', t:'<b style="color:#2dd4bf">Test Vitesse:</b> <b>1.0 m/s</b> (Lent) s\'il ne vous voit pas. <b>3.0 m/s</b> (TGV) d√®s qu\'il vous voit.' },
  { n:'Ombre', p:['emf','wrt','frz'], th:35, sp:'1.7', t:'<b style="color:#2dd4bf">Test Timide:</b> Ne chasse pas si plusieurs joueurs dans la pi√®ce.' },
  { n:'D√©mon', p:['wrt','uv','frz'], th:70, sp:'1.7', t:'<b style="color:#2dd4bf">Test Aggro:</b> Chasse toutes les 20s. Encens ne dure que 60s. ‚úùÔ∏è Craint le Crucifix √† <b>5m</b> (au lieu de 3m).' },
  { n:'Yurei', p:['dot','orb','frz'], th:50, sp:'1.7', t:'<b style="color:#2dd4bf">Test Porte:</b> Claque la porte d\'entr√©e (-15% San). Coinc√© dans sa pi√®ce par encens.' },
  { n:'Oni', p:['dot','emf','frz'], th:50, sp:'1.7', t:'‚ùå Ne fait <b>JAMAIS</b> l\'event "Boule de fum√©e" (le souffle). Clignote tr√®s peu en chasse.' },
  { n:'Yokai', p:['dot','orb','box'], th:80, sp:'1.7', t:'<b style="color:#2dd4bf">Test Voix:</b> Chasse √† 80% si on parle. Sourd (ne vous entend pas √† +2m).' },
  { n:'Hantu', p:['orb','uv','frz'], th:50, sp:'2.7', t:'‚ö° <b style="color:#2dd4bf">Courant:</b> Ne peut <b>JAMAIS</b> allumer. <b style="color:#2dd4bf">Unique:</b> Crache de la bu√©e visible pendant la chasse (si froid).' },
  { n:'Goryo', p:['dot','emf','uv'], th:50, sp:'1.7', t:'<b style="color:#2dd4bf">Test DOTS:</b> Visible <b>QUE</b> via cam√©ra et si personne dans la pi√®ce.' },
  { n:'Myling', p:['wrt','emf','uv'], th:50, sp:'1.7', t:'<b style="color:#2dd4bf">Test Son:</b> Pas inaudibles (pas de bruit de pas). Si vous entendez ses pas, votre lampe clignote d√©j√†.' },
  { n:'Onryo', p:['orb','frz','box'], th:60, sp:'1.7', t:'<b style="color:#2dd4bf">Test Feu:</b> La bougie agit comme crucifix. √âteinte 3 fois => CHASSE.' },
  { n:'Jumeaux', p:['emf','frz','box'], th:50, sp:'Var', t:'<b style="color:#2dd4bf">Test Double:</b> Interactions √† deux endroits. Vitesse varie.' },
  { n:'Raiju', p:['dot','emf','orb'], th:65, sp:'2.5', t:'<b style="color:#2dd4bf">Test Elec:</b> Acc√©l√®re pr√®s des objets √©lectroniques actifs.' },
  { n:'Obake', p:['emf','orb','uv'], th:50, sp:'1.7', t:'<b style="color:#2dd4bf">Test UV:</b> Empreinte √† 6 doigts. Change de forme 1 fois par chasse.' },
  { n:'Mimic', p:['box','uv','frz'], th:50, sp:'Var', t:'<b style="color:#2dd4bf">Test Orbe:</b> A toujours des orbes (4e preuve). Copie les autres.' },
  { n:'Moroi', p:['box','wrt','frz'], th:50, sp:'Var', t:'<b style="color:#2dd4bf">Test Maudit:</b> Spirit Box draine la sant√©. Vitesse augmente si Sanit√© basse.' },
  { n:'Deogen', p:['dot','wrt','box'], th:40, sp:'3.0', t:'<b style="color:#2dd4bf">Test Vitesse:</b> <b>3.0 m/s</b> quand il est loin. <b>0.4 m/s</b> (Escargot) tout pr√®s. On ne peut pas se cacher !' },
  { n:'Thaye', p:['dot','orb','wrt'], th:75, sp:'2.7', t:'<b style="color:#2dd4bf">Test Age:</b> Rapide au d√©but -> Lent √† la fin.' },
  { n:'Dayan', p:['emf','orb','box'], th:65, sp:'Var', t:'‚ôÄÔ∏è <b>FEMME uniquement.</b> <b style="color:#warn">Custom:</b> Vitesse change si joueur bouge.' },
  { n:'Gallu', p:['emf','uv','box'], th:60, sp:'1.7', t:'<b style="color:#warn">Custom:</b> Enrag√© par objets d√©fensifs.' },
  { n:'Obambo', p:['wrt','uv','dot'], th:60, sp:'Var', t:'<b style="color:#warn">Custom:</b> Alterne phases Calme/Agressif.' }
];

const LOCATIONS = {
  'tanglewood': [ { i:'üîÆ', n:'Miroir', l:'Salon (Mur vers chambre)' }, { i:'üß©', n:'Ouija', l:'Sous-sol (Fond gauche)' }, { i:'üß∏', n:'Poup√©e', l:'Garage (Poubelle)' }, { i:'‚≠ï', n:'Cercle', l:'Sous-sol' }, { i:'üÉè', n:'Tarot', l:'Salon' }, { i:'üì¶', n:'Bo√Æte', l:'Nursery' }, { i:'‚úã', n:'Patte', l:'Salle √† manger' } ],
  'willow': [ { i:'üîÆ', n:'Miroir', l:'Couloir (Coin)' }, { i:'üß©', n:'Ouija', l:'Garage (Buanderie)' }, { i:'üß∏', n:'Poup√©e', l:'Chambre gar√ßons' }, { i:'‚≠ï', n:'Cercle', l:'Sous-sol' }, { i:'üÉè', n:'Tarot', l:'Salon' }, { i:'üì¶', n:'Bo√Æte', l:'Salon' }, { i:'‚úã', n:'Patte', l:'Couloir' } ],
  'edgefield': [ { i:'üîÆ', n:'Miroir', l:'1er √©tage' }, { i:'üß©', n:'Ouija', l:'Buanderie' }, { i:'üß∏', n:'Poup√©e', l:'1er √©tage (Ado)' }, { i:'‚≠ï', n:'Cercle', l:'Sous-sol' }, { i:'üÉè', n:'Tarot', l:'Entr√©e' }, { i:'üì¶', n:'Bo√Æte', l:'Salon' }, { i:'‚úã', n:'Patte', l:'Cuisine' } ],
  'ridgeview': [ { i:'üîÆ', n:'Miroir', l:'RDC (Escaliers)' }, { i:'üß©', n:'Ouija', l:'Buanderie' }, { i:'üß∏', n:'Poup√©e', l:'Couloir RDC' }, { i:'‚≠ï', n:'Cercle', l:'Sous-sol' }, { i:'üÉè', n:'Tarot', l:'Entr√©e' }, { i:'üì¶', n:'Bo√Æte', l:'Chambre Fille' }, { i:'‚úã', n:'Patte', l:'Chambre Gar√ßon' } ],
  'grafton': [ { i:'üîÆ', n:'Miroir', l:'Salon' }, { i:'üß©', n:'Ouija', l:'Chambre Master' }, { i:'üß∏', n:'Poup√©e', l:'Nursery' }, { i:'‚≠ï', n:'Cercle', l:'Entrep√¥t' }, { i:'üÉè', n:'Tarot', l:'Salle √† manger' }, { i:'üì¶', n:'Bo√Æte', l:'Entr√©e' }, { i:'‚úã', n:'Patte', l:'Chambre Jumelle' } ],
  'bleasdale': [ { i:'üîÆ', n:'Miroir', l:'Bureau RDC' }, { i:'üß©', n:'Ouija', l:'Atelier' }, { i:'üß∏', n:'Poup√©e', l:'Couloir 2e' }, { i:'‚≠ï', n:'Cercle', l:'Grenier' }, { i:'üÉè', n:'Tarot', l:'Bureau RDC' }, { i:'üì¶', n:'Bo√Æte', l:'Salon' }, { i:'‚úã', n:'Patte', l:'Chambre Master' } ],
  'woodwind': [ { i:'üîÆ', n:'Miroir', l:'Tente d√©part' }, { i:'üß©', n:'Ouija', l:'Zone Jeux' }, { i:'üß∏', n:'Poup√©e', l:'Tente rouge' }, { i:'‚≠ï', n:'Cercle', l:'Tente Nourriture' }, { i:'üÉè', n:'Tarot', l:'Entr√©e' }, { i:'üì¶', n:'Bo√Æte', l:'Tente Jaune' }, { i:'‚úã', n:'Patte', l:'Feu de camp' } ],
  'prison': [ { i:'üîÆ', n:'Miroir', l:'Entr√©e' }, { i:'üß©', n:'Ouija', l:'Arri√®re cellules A' }, { i:'üß∏', n:'Poup√©e', l:'Accueil' }, { i:'‚≠ï', n:'Cercle', l:'Caf√©t√©ria' }, { i:'üÉè', n:'Tarot', l:'Entr√©e' }, { i:'üì¶', n:'Bo√Æte', l:'Entr√©e' }, { i:'‚úã', n:'Patte', l:'Visiteurs' } ],
  'sunny': [ { i:'üîÆ', n:'Miroir', l:'Chapelle' }, { i:'üß©', n:'Ouija', l:'Chapelle' }, { i:'üß∏', n:'Poup√©e', l:'Chapelle' }, { i:'‚≠ï', n:'Cercle', l:'Chapelle' }, { i:'üÉè', n:'Tarot', l:'Chapelle' }, { i:'üì¶', n:'Bo√Æte', l:'Chapelle' }, { i:'‚úã', n:'Patte', l:'Chapelle' } ]
};

// === GLOBAL VARS & AUDIO ===
let state = { inc: [], exc: [], manual: [], san: 100, search: '' };
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();
let metroId = null;
let tInterval = null;
let lastTap = 0;

// === INIT ===
function init() {
  loadState();
  renderProofs();
  renderGhosts();
  setTab('tracker');
}

// === LOGIC ===
function setTab(tabName, btnMobile) {
  document.getElementById('view-tracker').classList.add('hidden');
  document.getElementById('view-tools').classList.add('hidden');
  document.getElementById('view-guides').classList.add('hidden');
  
  document.getElementById('view-'+tabName).classList.remove('hidden');
  
  document.querySelectorAll('.mn-item').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  
  if(btnMobile) btnMobile.classList.add('active'); // Mobile style
  else {
    // PC style sync
    const pcBtns = document.querySelectorAll('.nav-item');
    if(tabName==='tracker') pcBtns[0].classList.add('active');
    if(tabName==='tools') pcBtns[1].classList.add('active');
    if(tabName==='guides') pcBtns[2].classList.add('active');
  }
}

function renderProofs() {
  const html = PROOFS.map(p => {
    let st = '';
    if(state.inc.includes(p.id)) st = 'data-state="inc"';
    if(state.exc.includes(p.id)) st = 'data-state="exc"';
    return `<button class="proof-btn" ${st} onclick="toggleProof('${p.id}')">${p.label}</button>`;
  }).join('');
  
  document.getElementById('mobile-proofs').innerHTML = html; 
  document.getElementById('pc-proofs-list').innerHTML = html.replace(/proof-btn/g, 'proof-btn btn-action'); 
}

function toggleProof(id) {
  if(state.inc.includes(id)) {
    state.inc = state.inc.filter(x=>x!==id);
    state.exc.push(id);
  } else if(state.exc.includes(id)) {
    state.exc = state.exc.filter(x=>x!==id);
  } else {
    state.inc.push(id);
  }
  saveState(); renderProofs(); renderGhosts();
}

function renderGhosts() {
  const container = document.getElementById('ghost-grid');
  container.innerHTML = GHOSTS.map(g => {
    let gp = [...g.p]; if(g.n==='Mimic') gp.push('orb');
    
    // Filtres
    const impossible = state.inc.some(id => !gp.includes(id));
    const excluded = state.exc.some(id => {
      if(g.n==='Mimic' && id==='orb') return false;
      return gp.includes(id);
    });
    const manuallyKilled = state.manual.includes(g.n);
    
    // Recherche
    let searchMatch = true;
    if(state.search) {
      const str = (g.n + ' ' + g.t).toLowerCase();
      if(!str.includes(state.search.toLowerCase())) searchMatch = false;
    }

    if((impossible || excluded) && !manuallyKilled) return ''; 

    let cls = 'ghost candidate';
    if(manuallyKilled) cls = 'ghost manual-excluded';

    return `
      <div class="${cls}">
        <div class="g-head">
          <span class="g-name">${g.n}</span>
          <span style="font-size:0.8rem; font-weight:bold; color:var(--accent)">${g.sp} m/s</span>
        </div>
        <div class="g-meta">
          ${g.p.map(pid => {
            const lbl = PROOFS.find(x=>x.id===pid).label;
            const match = state.inc.includes(pid) ? 'match' : '';
            return `<span class="badge ${match}">${lbl}</span>`;
          }).join('')}
          ${g.n==='Mimic' ? '<span class="badge">Fake Orbe</span>' : ''}
        </div>
        <div style="font-size:0.85rem; color:#cbd5e1; margin-bottom:8px; line-height:1.4;">${g.t}</div>
        <div class="g-actions">
          <button class="btn-action metro-btn" onclick="toggleGhostMetro('${g.sp}', this)">üîä Son</button>
          <button class="btn-action" onclick="toggleManual('${g.n}')">${manuallyKilled ? 'R√©tablir' : '√âliminer'}</button>
        </div>
      </div>
    `;
  }).join('');
}

function toggleManual(name) {
  if(state.manual.includes(name)) state.manual = state.manual.filter(x=>x!==name);
  else state.manual.push(name);
  saveState(); renderGhosts();
}

function setSearch(val) { state.search = val; renderGhosts(); }

// === AUDIO (Fix Mobile) ===
function toggleGhostMetro(speed, btn) {
  if(btn.classList.contains('active')) { stopMetronome(); return; }
  stopMetronome();
  let v = parseFloat(speed) || 1.7;
  startMetronome(v, btn);
}

function startMetronome(speed, btn) {
  if(audioCtx.state === 'suspended') audioCtx.resume();
  stopMetronome();
  if(btn) btn.classList.add('active');
  
  let delay = 600;
  if(speed > 0) delay = 1000 / (speed / 1.7 * 1.5);

  metroId = setInterval(() => {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.frequency.value = 800; g.gain.value = 0.1;
    o.start(); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
    o.stop(audioCtx.currentTime + 0.1);
  }, delay);
}

function stopMetronome() {
  clearInterval(metroId);
  document.querySelectorAll('.metro-btn, .btn-action').forEach(b => b.classList.remove('active'));
}

function tapBpm() {
  const now = Date.now();
  if(lastTap) {
    const diff = (now - lastTap)/1000;
    const est = (1/diff)*1.1;
    document.getElementById('bpm-val').innerText = est.toFixed(1) + " m/s";
  }
  lastTap = now;
  setTimeout(() => { if(Date.now()-lastTap > 2000) lastTap=0; }, 2000);
}

// === TIMER ===
function runTimer(s) {
  if(audioCtx.state === 'suspended') audioCtx.resume();
  clearInterval(tInterval);
  let t = s;
  const tick = () => {
    let m = Math.floor(t/60).toString().padStart(2,'0');
    let sec = (t%60).toString().padStart(2,'0');
    document.getElementById('timer-disp').innerText = `${m}:${sec}`;
  };
  tick();
  tInterval = setInterval(() => {
    t--; tick();
    if(t<=0) {
      clearInterval(tInterval);
      document.getElementById('timer-disp').innerText = "PRET";
      const o=audioCtx.createOscillator(); o.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime+0.5);
    }
  }, 1000);
}
function stopTimer() { clearInterval(tInterval); document.getElementById('timer-disp').innerText = "00:00"; }

// === MAPS ===
function loadLocs(key) {
  const div = document.getElementById('loc-area');
  if(!key) { div.innerHTML=''; return; }
  const data = LOCATIONS[key] || [];
  div.innerHTML = data.map(i => `<div style="padding:10px; border-bottom:1px solid #333"><b>${i.i} ${i.n}</b><br><span style="color:#94a3b8">${i.l}</span></div>`).join('');
}

// === SANITY ===
function setSan(v) { state.san = v; document.getElementById('san-disp').innerText = v+"%"; saveState(); }

// === STORAGE ===
function saveState() { localStorage.setItem('phasmo_v21', JSON.stringify(state)); }
function loadState() {
  const s = localStorage.getItem('phasmo_v21');
  if(s) state = JSON.parse(s);
}
function resetAll() {
  if(confirm('Tout remettre √† z√©ro ?')) {
    localStorage.removeItem('phasmo_v21');
    location.reload();
  }
}

init();
</script>
</body>
</html>
