<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <title>PHASMO-TRACKER Ultimate v36.0</title>
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üëª</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üëª</text></svg>">
  
  <meta property="og:site_name" content="Phasmo-Tracker Ultimate" />
  <meta property="og:title" content="Tracker Phasmophobia Expert v36.0" />
  <meta name="description" content="Tracker Phasmophobia avec Analyseur Audio de Chasse, Modes de Difficult√©, IA Vocale." />
  <meta name="author" content="Sebag Joshua & Logeais Ma√©lann" />
  <meta name="theme-color" content="#0f172a">
  <meta name="google-site-verification" content="JgHSgqTfww6oZH2IdNMV8B5l6QsDQdTVgnMvWqpjd08" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Phasmo-Tracker Ultimate",
    "url": "https://joshuasebag.github.io/phasmo-guide/",
    "description": "Le tracker ultime pour Phasmophobia."
  }
  </script>

  <style>
    :root { --bg: #0f172a; --panel: #1e293b; --accent: #2dd4bf; --text: #f1f5f9; --border: #334155; --danger: #ef4444; --success: #10b981; --warn: #f59e0b; --purple: #a855f7; --nav-height: 60px; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    .app-layout { display: flex; height: 100%; width: 100%; overflow: hidden; }
    .controls-area { background: #020617; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; overflow-y: auto; transition: 0.3s; }
    .main-area { flex: 1; overflow-y: auto; padding: 15px; position: relative; scroll-behavior: smooth; }

    .pc-only { display: block; } .mobile-only { display: none; }
    
    @media (min-width: 900px) {
      .controls-area { width: 340px; padding: 20px; }
      .mobile-nav, .mobile-proof-bar { display: none !important; }
      .pc-header { display: block; margin-bottom: 15px; font-size: 1.2rem; font-weight: 900; color: var(--accent); letter-spacing: 1px; }
      .nav-pills { display: flex; gap: 5px; margin-bottom: 15px; background: #1e293b; padding: 5px; border-radius: 8px; }
      .nav-item { flex: 1; padding: 8px; border: none; background: transparent; color: #94a3b8; cursor: pointer; font-weight: bold; border-radius: 6px; transition: 0.2s; }
      .nav-item.active { background: var(--accent); color: #000; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
    }
    @media (max-width: 899px) {
      .app-layout { flex-direction: column; }
      .controls-area, .pc-header { display: none; }
      .pc-only { display: none !important; } .mobile-only { display: block !important; }
      .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: #0f172a; border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
      .mn-item { background: none; border: none; color: #64748b; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 4px; font-weight: bold; width: 100%; padding: 8px 0; }
      .mn-item.active { color: var(--accent); }
      .mn-icon { font-size: 1.2rem; }
      .mobile-proof-bar { position: sticky; top: 0; z-index: 50; background: rgba(15,23,42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); padding: 8px; display: flex; gap: 8px; overflow-x: auto; white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none; transition: 0.3s; }
      .mobile-proof-bar::-webkit-scrollbar { display: none; }
      .main-area { padding-bottom: 80px; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    }

    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .proof-btn, .sidebar-btn { flex: 0 0 auto; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #1e293b; color: #cbd5e1; font-weight: bold; font-size: 0.85rem; cursor: pointer; transition: 0.2s; user-select: none; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .sidebar-section { margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; }
    .sidebar-title { color: var(--accent); font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px; }
    .sidebar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
    .proof-btn[data-state="inc"] { background: var(--success); color: #000; border-color: var(--success); }
    .proof-btn[data-state="exc"] { background: var(--danger); color: #fff; border-color: var(--danger); text-decoration: line-through; opacity: 0.7; }
    .sidebar-btn.active { background: var(--success); color: #000; border-color: var(--success); animation: pulse 1s infinite; }
    .sidebar-btn.stop { border-color: var(--danger); color: var(--danger); } .sidebar-btn.stop:active { background: var(--danger); color: white; }

    /* FILTRES & UI */
    .speed-filter-container { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 5px; margin-bottom: 15px; }
    .speed-btn { padding: 8px; background: #1e293b; border: 1px solid var(--border); border-radius: 6px; color: #94a3b8; font-weight: bold; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
    .speed-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
    .speed-btn.reset { border-color: var(--danger); color: var(--danger); }

    .diff-container { display: flex; gap: 5px; margin-bottom: 15px; }
    .diff-select { flex:1; padding: 8px; background: #020617; border: 1px solid var(--border); color: var(--text); border-radius: 6px; font-weight: bold; font-size: 0.85rem; cursor: pointer; }
    .btn-reset-pc { width: 40px; background: #1e293b; border: 1px solid var(--danger); color: var(--danger); border-radius: 6px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }
    .btn-reset-pc:hover { background: var(--danger); color: white; }

    .search-container { display: flex; gap: 10px; margin-bottom: 10px; }
    .search-input { flex: 1; padding: 12px; background: #0f172a; border: 1px solid var(--accent); color: white; border-radius: 8px; font-size: 1rem; }
    .mic-btn { width: 50px; background: #1e293b; border: 1px solid var(--border); border-radius: 8px; color: #cbd5e1; cursor: pointer; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
    .mic-btn.listening { background: var(--danger); color: white; border-color: var(--danger); animation: pulse-red 1.5s infinite; }

    /* ANALYSEUR AUDIO */
    .audio-viz-container { margin-top: 10px; background: #000; padding: 10px; border-radius: 8px; border: 1px solid #333; display: none; }
    .audio-viz-container.active { display: block; animation: slideDown 0.3s; }
    .audio-bar-wrapper { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; }
    .audio-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.05s ease-out; }
    .audio-bar.peak { background: var(--danger); }
    .audio-stats { display: flex; justify-content: space-between; font-size: 0.8rem; color: #cbd5e1; margin-top: 5px; font-family: monospace; }

    /* AI BOX & GHOSTS */
    .ai-box { background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(30, 41, 59, 0.5)); border: 1px solid #38bdf8; border-left: 4px solid #38bdf8; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: none; animation: slideDown 0.3s ease-out; }
    .ai-box.visible { display: block; }
    .ai-title { color: #38bdf8; font-weight: 900; margin-bottom: 5px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
    .ai-content { font-size: 0.9rem; color: #e0f2fe; line-height: 1.4; }

    .ghost { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; position: relative; transition: 0.2s; }
    .ghost.excluded { display: none; }
    .ghost.manual-excluded { opacity: 0.4; order: 10; display: block; filter: grayscale(1); border-style: dashed; }
    .ghost.candidate { border-color: var(--accent); order: 1; box-shadow: 0 0 10px rgba(45,212,191,0.1); }
    .g-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .g-name { font-size: 1.2rem; font-weight: 900; color: white; }
    .g-meta { font-size: 0.8rem; color: #94a3b8; display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
    .g-actions { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 5px; margin-top: 8px; }
    .btn-action { padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: #0f172a; color: #cbd5e1; font-weight: bold; font-size: 0.75rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; }
    .btn-action.active { background: var(--accent); color: black; animation: pulse 1s infinite; border-color: var(--accent); }
    .g-details { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border); font-size: 0.85rem; line-height: 1.5; color: #e2e8f0; }
    .g-details.open { display: block; animation: slideDown 0.3s ease-out; }
    .g-details h5 { color: var(--accent); margin: 10px 0 4px 0; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 2px; }
    .g-details ul { margin: 0; padding-left: 20px; } .g-details li { margin-bottom: 4px; }
    .highlight { background-color: #facc15; color: #000; font-weight: bold; border-radius: 2px; padding: 0 2px; }

    .obj-card { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-start; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid #333; }
    .obj-icon { font-size: 2rem; min-width: 40px; text-align: center; }
    .obj-info h4 { margin: 0 0 5px 0; color: var(--accent); font-size: 1rem; }
    .obj-info p { margin: 0; font-size: 0.85rem; color: #cbd5e1; line-height: 1.4; }
    .obj-list { margin: 5px 0 0 0; padding-left: 20px; font-size: 0.8rem; color: #94a3b8; }
    .obj-list li { margin-bottom: 3px; }
    .risk { display: block; margin-top: 5px; color: var(--danger); font-weight: bold; font-size: 0.8rem; }
    .hidden { display: none !important; } .text-center { text-align: center; }
    .badge { font-size: 0.7rem; padding: 2px 6px; background: #000; border-radius: 4px; color: #64748b; border: 1px solid #333; } .badge.match { color: var(--success); border-color: var(--success); }
    .timer-val { font-family: monospace; font-size: 1.5rem; color: var(--warn); text-align: center; background: #000; border-radius: 6px; padding: 4px; margin-bottom: 5px; border: 1px solid #333; }
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -6px; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div class="mobile-proof-bar" id="mobile-proofs"></div>

<div class="app-layout">
  <aside class="controls-area">
    <div class="pc-header">
      PHASMO ULTIMATE üëª 
      <span style="font-size:0.5em; vertical-align:middle; color:#f59e0b; opacity:0.8; margin-left:5px;">v36.0</span>
    </div>
    
    <div class="diff-container">
      <select id="diff-select" class="diff-select" onchange="setDiff(this.value)">
        <option value="ama">üü¢ 3 Preuves (Normal)</option>
        <option value="night">üî¥ 2 Preuves (Cauch.)</option>
        <option value="ins">üü£ 1 Preuve (D√©mence)</option>
        <option value="apoc">‚ö´ 0 Preuve (Apoc.)</option>
      </select>
      <button class="btn-reset-pc" onclick="resetGame()" title="Reset Partie">‚Üª</button>
    </div>

    <div class="nav-pills">
      <button class="nav-item active" onclick="setTab('tracker')">JOURNAL</button>
      <button class="nav-item" onclick="setTab('tools')">CARTES</button>
      <button class="nav-item" onclick="setTab('guides')">GUIDES</button>
    </div>
    
    <div id="pc-proofs-list" style="display: flex; flex-direction: column; gap: 5px;"></div>
    
    <div class="sidebar-section">
      <div class="sidebar-title">‚è±Ô∏è CHRONOM√àTRE</div>
      <div class="timer-val" id="timer-disp-sidebar">00:00</div>
      <div class="sidebar-grid">
        <button class="sidebar-btn" onclick="runTimer(90)">90s</button>
        <button class="sidebar-btn" onclick="runTimer(180)">180s</button>
      </div>
      <button class="sidebar-btn stop" style="width:100%" onclick="stopTimer()">STOP</button>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-title">üîä M√âTRONOME & VITESSE</div>
      
      <button class="sidebar-btn" onclick="toggleAudioAnalyzer('sidebar')" style="width:100%; margin-bottom:8px; border-color:var(--accent); color:var(--accent);">üé§ ANALYSE AUDIO (B√äTA)</button>
      
      <div id="audio-viz-sidebar" class="audio-viz-container">
        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#94a3b8;">
          <span>Sensibilit√©:</span>
          <input type="range" min="0" max="100" value="50" oninput="setAudioThreshold(this.value)" style="width:60%">
        </div>
        <div class="audio-bar-wrapper"><div class="audio-bar" id="audio-bar-sidebar"></div></div>
        <div class="audio-stats">
          <span>BPM: <span id="audio-bpm-sidebar" style="color:var(--accent)">--</span></span>
          <span>~<span id="audio-speed-sidebar" style="color:var(--accent)">--</span> m/s</span>
        </div>
      </div>

      <div class="sidebar-grid">
        <button class="sidebar-btn metro-btn" onclick="startMetronome(1.0, this)">üê¢ 1.0</button>
        <button class="sidebar-btn metro-btn" onclick="startMetronome(1.7, this)">üö∂ 1.7</button>
        <button class="sidebar-btn metro-btn" onclick="startMetronome(2.5, this)">üêá 2.5</button>
        <button class="sidebar-btn stop" onclick="stopMetronome()">OFF</button>
      </div>
      <div style="margin-top:10px; border-top:1px dashed #334155; padding-top:8px;">
        <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#94a3b8; margin-bottom:5px;">
          <span>Vitesse:</span><span style="color:var(--accent); font-weight:bold;"><span id="speed-val-sidebar">1.7</span> m/s</span>
        </div>
        <input type="range" id="speed-slider-sidebar" min="0.5" max="4.0" step="0.1" value="1.7" oninput="updateSpeed(this.value)">
        <button class="sidebar-btn" id="btn-custom-play-sidebar" style="width:100%; margin-top:5px; font-size:0.8rem;" onclick="playCustomSpeed()">‚ñ∂Ô∏è JOUER VITESSE</button>
      </div>
      <button class="sidebar-btn" style="width:100%; margin-top:10px" onmousedown="tapBpm()">üë£ TAP BPM: <span id="bpm-val-sidebar" style="margin-left:5px">--</span></button>
    </div>

    <div style="margin-top: 20px; text-align: center; font-size: 0.8rem; color: #64748b; border-top: 1px solid #333; padding-top: 10px;">
      Dev: <span style="color:var(--accent)">Sebag Joshua</span> & <span style="color:var(--accent)">Logeais Ma√©lann</span>
    </div>
  </aside>

  <main class="main-area" id="main-content">
    
    <div id="view-tracker">
      <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="üîç Ex: 'Il court vite', 'Disjoncteur'..." oninput="setSearch(this.value)">
        <button class="mic-btn" onclick="toggleVoice()" id="mic-btn">üéôÔ∏è</button>
      </div>
      
      <div class="speed-filter-container">
        <button class="speed-btn" onclick="filterSpeed('slow')" id="btn-speed-slow">üê¢ LENT</button>
        <button class="speed-btn" onclick="filterSpeed('normal')" id="btn-speed-normal">üö∂ NORMAL</button>
        <button class="speed-btn" onclick="filterSpeed('fast')" id="btn-speed-fast">üêá RAPIDE</button>
        <button class="speed-btn reset" onclick="filterSpeed(null)">‚ùå</button>
      </div>

      <div id="ai-suggestion" class="ai-box">
        <div class="ai-title">ü§ñ CONSEIL IA</div>
        <div class="ai-content" id="ai-text"></div>
      </div>
      <div id="ghost-grid" class="grid"></div>
    </div>

    <div id="view-tools" class="hidden">
      <div class="card mobile-only">
        <h4 style="margin:0 0 10px 0; color:var(--accent)">CHRONO ‚è±Ô∏è</h4>
        <div class="timer-val" id="timer-disp-mobile">00:00</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px">
          <button class="sidebar-btn" onclick="runTimer(90)">90s</button>
          <button class="sidebar-btn" onclick="runTimer(180)">180s</button>
          <button class="sidebar-btn stop" style="grid-column: span 2;" onclick="stopTimer()">STOP</button>
        </div>
      </div>
      <div class="card mobile-only">
        <h4 style="margin:0 0 10px 0; color:var(--accent)">M√âTRONOME üîä</h4>
        <button class="sidebar-btn" onclick="toggleAudioAnalyzer('mobile')" style="width:100%; margin-bottom:8px; border-color:var(--accent); color:var(--accent);">üé§ ANALYSE AUDIO (B√äTA)</button>
        <div id="audio-viz-mobile" class="audio-viz-container">
          <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#94a3b8;">
            <span>Sensibilit√©:</span>
            <input type="range" min="0" max="100" value="50" oninput="setAudioThreshold(this.value)" style="width:60%">
          </div>
          <div class="audio-bar-wrapper"><div class="audio-bar" id="audio-bar-mobile"></div></div>
          <div class="audio-stats">
            <span>BPM: <span id="audio-bpm-mobile" style="color:var(--accent)">--</span></span>
            <span>~<span id="audio-speed-mobile" style="color:var(--accent)">--</span> m/s</span>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px">
          <button class="sidebar-btn metro-btn" onclick="startMetronome(1.0, this)">üê¢ 1.0</button>
          <button class="sidebar-btn metro-btn" onclick="startMetronome(1.7, this)">üö∂ 1.7</button>
          <button class="sidebar-btn metro-btn" onclick="startMetronome(2.5, this)">üêá 2.5</button>
        </div>
        <div style="margin-top:15px; border-top:1px dashed #334155; padding-top:10px;">
          <div style="display:flex; justify-content:space-between; font-size:0.9rem; color:#94a3b8; margin-bottom:8px;">
            <span>Vitesse:</span><span style="color:var(--accent); font-weight:bold;"><span id="speed-val-mobile">1.7</span> m/s</span>
          </div>
          <input type="range" id="speed-slider-mobile" min="0.5" max="4.0" step="0.1" value="1.7" oninput="updateSpeed(this.value)">
          <button class="sidebar-btn" id="btn-custom-play-mobile" style="width:100%; margin-top:10px;" onclick="playCustomSpeed()">‚ñ∂Ô∏è JOUER VITESSE</button>
        </div>
        <button class="sidebar-btn stop" style="width:100%; margin-top:10px" onclick="stopMetronome()">STOP SON</button>
        <button class="sidebar-btn" style="width:100%; margin-top:5px" onmousedown="tapBpm()">üë£ TAP BPM: <span id="bpm-val-mobile">--</span></button>
      </div>

      <div class="card">
        <h4 style="margin:0 0 10px 0; color:var(--accent)">OBJETS MAUDITS üó∫Ô∏è</h4>
        <select class="search-input" onchange="loadLocs(this.value)">
          <option value="">-- CHOISIR UNE CARTE --</option>
          <option value="tanglewood">6 Tanglewood Drive</option>
          <option value="willow">Willow Street</option>
          <option value="edgefield">42 Edgefield Road</option>
          <option value="ridgeview">10 Ridgeview Court</option>
          <option value="grafton">Grafton Farmhouse</option>
          <option value="bleasdale">Bleasdale Farmhouse</option>
          <option value="woodwind">Camp Woodwind</option>
          <option value="prison">Prison</option>
          <option value="sunny">Sunny Meadows</option>
        </select>
        <div id="loc-area"></div>
      </div>
      <div class="card">
        <div style="display:flex; justify-content:space-between;"><span>üß† Sant√© Mentale</span><span id="san-disp" style="color:var(--accent)">100%</span></div>
        <input type="range" style="width:100%" min="0" max="100" value="100" id="san-slider" oninput="setSan(this.value)">
      </div>
    </div>

    <div id="view-guides" class="hidden">
      <div class="card">
        <h4 style="color:var(--accent); margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">üîÆ GUIDE DES OBJETS MAUDITS</h4>
        <div class="obj-card"><div class="obj-icon">üÉè</div><div class="obj-info"><h4>Cartes de Tarot</h4><ul class="obj-list"><li><b style="color:#facc15">Soleil</b>: 100% Sant√©</li><li><b style="color:#ef4444">Lune</b>: 0% Sant√©</li><li><b style="color:#2dd4bf">Tour</b>: Interaction</li><li><b style="color:#facc15">Roue</b>: +/- 25% Sant√©</li><li><b style="color:#ef4444">Diable</b>: Event</li><li><b style="color:#ef4444">Mort</b>: CHASSE MAUDITE</li><li><b style="color:#a855f7">Ermite</b>: Bloque 1min</li><li><b style="color:#10b981">Pr√™tresse</b>: Ressuscite</li><li><b style="color:#ef4444">Pendu</b>: MORT</li><li><b style="color:#a855f7">Fou</b>: Troll</li></ul></div></div>
        <div class="obj-card"><div class="obj-icon">üß©</div><div class="obj-info"><h4>Ouija Board</h4><p>Dites <b>"Au revoir"</b> !</p><ul class="obj-list"><li>Lieu : <span class="risk">-50%</span></li><li>Os : <span class="risk">-50%</span></li><li>√Çge : <span class="risk">-5%</span></li><li>Cache-cache : <span class="risk">-25% + CHASSE</span></li></ul></div></div>
        <div class="obj-card"><div class="obj-icon">‚úã</div><div class="obj-info"><h4>Patte de Singe</h4><ul class="obj-list"><li><b>Voir:</b> Aveugle + Chasse</li><li><b>Revivre:</b> 50% chance mort</li><li><b>Partir:</b> Lent</li><li><b>Sain:</b> Sant√© 50% + Baisse</li><li><b>Pi√©ger:</b> Enferm√©</li></ul></div></div>
        <div class="obj-card"><div class="obj-icon">üé∂</div><div class="obj-info"><h4>Bo√Æte √† Musique</h4><span class="risk">Chasse si touch√©e/jet√©e. Joueur < 5m = Chasse. Co√ªt : -75%</span></div></div>
        <div class="obj-card"><div class="obj-icon">üß∏</div><div class="obj-info"><h4>Poup√©e Vaudou</h4><span class="risk">-5% par pic. C≈ìur = CHASSE (-10%).</span></div></div>
        <div class="obj-card"><div class="obj-icon">üîÆ</div><div class="obj-info"><h4>Miroir Hant√©</h4><span class="risk">-7.5%/s. 0% = CHASSE.</span></div></div>
        <div class="obj-card"><div class="obj-icon">‚≠ï</div><div class="obj-info"><h4>Cercle</h4><span class="risk">-16% par bougie (-80% total). Invoque et Chasse apr√®s 5s.</span></div></div>
      </div>
    </div>

  </main>
</div>

<nav class="mobile-nav">
  <button class="mn-item active" onclick="setTab('tracker', this)"><span class="mn-icon">üìì</span>Journal</button>
  <button class="mn-item" onclick="setTab('tools', this)"><span class="mn-icon">üß∞</span>Outils</button>
  <button class="mn-item" onclick="setTab('guides', this)"><span class="mn-icon">üìñ</span>Guides</button>
  <button class="mn-item" style="color:var(--danger)" onclick="resetGame()"><span class="mn-icon">üóëÔ∏è</span>Reset</button>
</nav>

<script>
const PROOFS = [ { id:'emf', label:'EMF 5' }, { id:'orb', label:'Orbe' }, { id:'box', label:'Box' }, { id:'frz', label:'Froid' }, { id:'uv', label:'UV' }, { id:'dot', label:'DOTS' }, { id:'wrt', label:'Ecrit' } ];

const AI_RULES = [
  { k: ['sel', 'salt'], m: "üë£ <b>Probl√®me de Sel ?</b> Le <b>SPECTRE</b> ne marche JAMAIS dedans. Le <b>GALLU</b> enrag√© ne marche pas dedans." },
  { k: ['rapide', 'vitesse', 'speed'], m: "‚ö° <b>Vitesse Anormale ?</b> V√©rifiez <b>Revenant</b> (Vue), <b>Hantu</b> (Froid), <b>Thaye</b> (Jeune), <b>Deogen</b> (Loin), <b>Moroi</b> (Sant√© basse), <b>Dayan</b> (Mouvement) ou <b>Obambo</b> (Agressif)." },
  { k: ['lent', 'slow'], m: "üê¢ <b>Fant√¥me Lent ?</b> <b>Deogen</b> (Pr√®s), <b>Revenant</b> (Cach√©), <b>Thaye</b> (Vieux), <b>Hantu</b> (Chaud), <b>Dayan</b> (Immobile) ou <b>Obambo</b> (Calme)." },
  { k: ['tot', 't√¥t', 'attaque', 'chasse'], m: "‚öîÔ∏è <b>Attaque Pr√©coce ?</b> <b>D√©mon</b> (70%), <b>Thaye</b> (75%), <b>Yokai</b> (80% voix), <b>Raiju</b> (65% √©lec), <b>Obambo</b> (65% agressif)." },
  { k: ['parler', 'voix', 'cri'], m: "üé§ <b>Voix ?</b> Le <b>Yokai</b> chasse si vous parlez. La <b>Banshee</b> crie au micro. Le <b>Deogen</b> respire √† la Spirit Box (1m)." },
  { k: ['lumiere', 'courant', 'lampe'], m: "üí° <b>√âlec ?</b> <b>Cauchemar</b> n'allume jamais. <b>Hantu</b> n'allume jamais courant. <b>Jinn</b> ne coupe jamais courant." },
  { k: ['objet', 'jeter'], m: "üì¶ <b>Objets ?</b> <b>Poltergeist</b> jette fort (Explosion)." },
  { k: ['photo'], m: "üì∏ <b>Photo ?</b> Si fant√¥me invisible sur photo valid√©e = <b>FANT√îME</b>." },
  { k: ['disparait', 'clignote'], m: "üëÅÔ∏è <b>Clignotement ?</b> Lent = <b>Fant√¥me</b>. Rapide = <b>Oni</b>. Forme = <b>Obake</b>." },
  { k: ['piece', 'favori', 'bouge'], m: "üè† <b>Pi√®ce favorite ?</b> Le <b>Goryo</b> ne change jamais de pi√®ce favorite." }
];

const GHOSTS = [
  { n:'Esprit', p:['emf','box','wrt'], th:50, sp:'1.7', t:'Basique. Test Encens.', d:'<h5>Test Encens</h5><ul><li>Ne chasse pas pendant <b>180s</b> apr√®s encens (les autres c\'est 90s).</li></ul>' },
  { n:'Spectre', p:['dot','emf','box'], th:50, sp:'1.7', t:'Ne marche pas dans le sel.', d:'<h5>Test Sel (100%)</h5><ul><li>Ne marche <b>JAMAIS</b> dans le sel.</li><li>S\'il marche dans le sel = Pas Spectre.</li><li>Peut se t√©l√©porter sur un joueur (EMF 2/5).</li></ul>' },
  { n:'Fant√¥me', p:['dot','uv','box'], th:50, sp:'1.7', t:'Photo vide. Clignote lent.', d:'<h5>Test Photo</h5><ul><li>Dispara√Æt sur la photo (Photo valid√©e mais vide).</li><li>Clignote lentement en chasse.</li><li>Draine sant√© si regard√©.</li></ul>' },
  { n:'Poltergeist', p:['uv','box','wrt'], th:50, sp:'1.7', t:'Jette objets.', d:'<h5>Explosion d\'Objets</h5><ul><li>Jette plusieurs objets en m√™me temps.</li><li>-2% de sant√© par objet jet√©.</li></ul>' },
  { n:'Banshee', p:['dot','orb','uv'], th:50, sp:'1.7', t:'Cible unique.', d:'<h5>Stalker</h5><ul><li>Ne tue que sa cible.</li><li>Cri unique au micro parabolique.</li><li>Chant = -15% sant√©.</li></ul>' },
  { n:'Djinn', p:['emf','uv','frz'], th:50, sp:'2.5', t:'Rapide si courant ON.', d:'<h5>Courant</h5><ul><li>Vitesse 2.5 m/s si courant ON et ligne de vue.</li><li>Ne coupe JAMAIS le courant.</li><li>Pouvoir : -25% sant√© si pr√®s du disjoncteur.</li></ul>' },
  { n:'Cauchemar', p:['orb','box','wrt'], th:60, sp:'1.7', t:'D√©teste lumi√®re.', d:'<h5>Obscurit√©</h5><ul><li>Chasse √† 60% dans le noir.</li><li>√âteint les lumi√®res instantan√©ment.</li><li>Ne peut PAS allumer la lumi√®re.</li></ul>' },
  { n:'Revenant', p:['orb','wrt','frz'], th:50, sp:'3.0', t:'TGV si vu.', d:'<h5>Vitesse Extr√™me</h5><ul><li><b>Cach√© :</b> 1.0 m/s (Lent).</li><li><b>Vu :</b> 3.0 m/s (Imm√©diat).</li></ul>' },
  { n:'Ombre', p:['emf','wrt','frz'], th:35, sp:'1.7', t:'Timide.', d:'<h5>Timidit√©</h5><ul><li>Ne chasse pas si >1 joueur dans la pi√®ce.</li><li>Chasse √† 35% seulement.</li><li>Events "Fum√©e" fr√©quents.</li></ul>' },
  { n:'D√©mon', p:['wrt','uv','frz'], th:70, sp:'1.7', t:'Agressif.', d:'<h5>Chasseur</h5><ul><li>Chasse √† 70%.</li><li>Cooldown 20s.</li><li>Encens = 60s.</li><li>Port√©e Crucifix 5m.</li></ul>' },
  { n:'Yurei', p:['dot','orb','frz'], th:50, sp:'1.7', t:'Portes.', d:'<h5>Porte</h5><ul><li>Ferme totalement la porte entr√©e hors chasse (-15% sant√©).</li><li>Encens le bloque dans sa pi√®ce.</li></ul>' },
  { n:'Oni', p:['dot','emf','frz'], th:50, sp:'1.7', t:'Visible.', d:'<h5>Visible</h5><ul><li>Clignote tr√®s peu en chasse.</li><li>Pas d\'event "Fum√©e".</li><li>-20% sant√© sur collision event.</li></ul>' },
  { n:'Yokai', p:['dot','orb','box'], th:80, sp:'1.7', t:'Sourd.', d:'<h5>Voix</h5><ul><li>Chasse √† 80% si on parle.</li><li>Entend √† < 2.5m en chasse.</li></ul>' },
  { n:'Hantu', p:['orb','uv','frz'], th:50, sp:'2.7', t:'Froid.', d:'<h5>Thermique</h5><ul><li>Rapide au froid (2.7 m/s).</li><li>Bu√©e visible en chasse (Courant OFF).</li><li>N\'allume JAMAIS le courant.</li></ul>' },
  { n:'Goryo', p:['dot','emf','uv'], th:50, sp:'1.7', t:'DOTS Cam√©ra.', d:'<h5>DOTS</h5><ul><li>Visible QUE cam√©ra vid√©o (Personne dans la pi√®ce).</li><li>Ne change jamais de pi√®ce.</li></ul>' },
  { n:'Myling', p:['wrt','emf','uv'], th:50, sp:'1.7', t:'Silencieux.', d:'<h5>Pas Discrets</h5><ul><li>Pas inaudibles √† > 12m.</li><li>Si lampe clignote sans bruit = Myling.</li></ul>' },
  { n:'Onryo', p:['orb','frz','box'], th:60, sp:'1.7', t:'Peur du Feu.', d:'<h5>Peur du Feu</h5><ul><li>Le feu agit comme un crucifix (port√©e 4m).</li><li>Priorit√© : Bougie > Crucifix.</li><li>S\'il souffle une bougie et qu\'il n\'y a pas d\'autre feu/crucifix = CHASSE (m√™me √† 100% sant√©).</li></ul>' },
  { n:'Jumeaux', p:['emf','frz','box'], th:50, sp:'Var', t:'Double.', d:'<h5>Deux Entit√©s</h5><ul><li>Un lent (1.5 m/s), un rapide (1.9 m/s).</li><li>Interactions simultan√©es.</li></ul>' },
  { n:'Raiju', p:['dot','emf','orb'], th:65, sp:'2.5', t:'Boost Elec.', d:'<h5>√âlectronique</h5><ul><li>Vitesse 2.5 m/s pr√®s des objets √©lectroniques actifs.</li><li>Brouille les √©quipements de loin (15m au lieu de 10m).</li><li>Chasse √† 65% si √©lectronique proche.</li></ul>' },
  { n:'Obake', p:['emf','orb','uv'], th:50, sp:'1.7', t:'Forme.', d:'<h5>Changeforme</h5><ul><li>Empreinte unique √† 6 doigts (16.7% chance).</li><li>Change de mod√®le 3D (pendant 1s) au moins une fois par chasse.</li><li>25% de chance de ne pas laisser d\'UV.</li></ul>' },
  { n:'Mimic', p:['box','uv','frz'], th:50, sp:'Var', t:'Copieur.', d:'<h5>L\'Imposteur</h5><ul><li>A toujours des ORBES (C\'est une fausse preuve, il en a 4 en tout).</li><li>Copie le comportement d\'un autre fant√¥me et change r√©guli√®rement.</li></ul>' },
  { n:'Moroi', p:['box','wrt','frz'], th:50, sp:'Var', t:'Maudit.', d:'<h5>Vitesse & Sant√©</h5><ul><li>Vitesse augmente quand sant√© baisse (Max 2.25 m/s √† 0%).</li><li>Aveugl√© 7.5s apr√®s encens (au lieu de 5s).</li><li>R√©ponse Spirit Box = Maudit (Baisse sant√© x2).</li></ul>' },
  { n:'Deogen', p:['dot','wrt','box'], th:40, sp:'3.0', t:'Traqueur.', d:'<h5>Vision Totale</h5><ul><li>Vous trouve TOUJOURS (Cachette inutile).</li><li>Rapide de loin (3.0 m/s), tr√®s lent de pr√®s (0.4 m/s).</li><li>Spirit Box : Respire fort (1m) au lieu de parler (33% chance).</li></ul>' },
  { n:'Thaye', p:['dot','orb','wrt'], th:75, sp:'2.7', t:'Vieillit.', d:'<h5>Vieillissement</h5><ul><li><b>Jeune :</b> Rapide (2.75 m/s), Actif, Chasse t√¥t (75%).</li><li><b>Vieux :</b> Lent (1.0 m/s), Calme, Chasse tard (15%).</li><li>Ne s\'acc√©l√®re pas avec la ligne de vue.</li></ul>' },
  /* NOUVEAUX */
  { n:'Dayan', p:['emf','orb','box'], th:65, sp:'Var', t:'D√©tecte Mouvement.', d:'<h5>Le Danseur</h5><ul><li><b>Unique :</b> Sait si vous bougez √† <10m.</li><li><b>Vitesse :</b> 1.2 m/s (Immobile) / 2.25 m/s (Bouge).</li><li><b>Chasse :</b> 65% (Bouge) / 45% (Immobile).</li></ul>' },
  { n:'Gallu', p:['uv','wrt','frz'], th:60, sp:'Var', t:'Cycles & Sel.', d:'<h5>L\'Enrag√©</h5><ul><li><b>Enrag√© :</b> 1.96 m/s. Ne marche PAS dans le sel.</li><li><b>Affaibli :</b> 1.36 m/s.</li><li>Change d\'√©tat avec Sel/Encens/Crucifix.</li></ul>' },
  { n:'Obambo', p:['wrt','uv','dot'], th:65, sp:'Var', t:'Double face.', d:'<h5>Le Bipolaire</h5><ul><li><b>Calme :</b> 1.45 m/s. Chasse √† 10% (Rare).</li><li><b>Agressif :</b> 1.96 m/s. Chasse √† 65%.</li><li>Change d\'√©tat toutes les 2 min ou si on le regarde.</li></ul>' }
];

let state = { inc: [], exc: [], manual: [], san: 100, search: '', speedFilter: null, difficulty: 'ama' };
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();
let metroId = null;
let tInterval = null;
let lastTap = 0;
let audioAnalysing = false;
let audioAnalyzerNode = null;
let audioSource = null;
let audioThreshold = 50; // 0-100%
let lastPeakTime = 0;
let beatTimes = [];

function init() { loadState(); renderProofs(); renderGhosts(); setTab('tracker'); }

function setTab(tabName, btnMobile) {
  document.getElementById('view-tracker').classList.add('hidden');
  document.getElementById('view-tools').classList.add('hidden');
  document.getElementById('view-guides').classList.add('hidden');
  document.getElementById('view-'+tabName).classList.remove('hidden');
  document.querySelectorAll('.mn-item').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  if(btnMobile) btnMobile.classList.add('active'); 
  else {
    const pcBtns = document.querySelectorAll('.nav-item');
    if(tabName==='tracker') pcBtns[0].classList.add('active');
    if(tabName==='tools') pcBtns[1].classList.add('active');
    if(tabName==='guides') pcBtns[2].classList.add('active');
  }
}

function setDiff(val) {
  state.difficulty = val;
  saveState();
  if(val === 'apoc') {
    state.inc = []; state.exc = [];
    document.getElementById('pc-proofs-list').style.display = 'none';
    document.getElementById('mobile-proofs').style.display = 'none';
  } else {
    document.getElementById('pc-proofs-list').style.display = 'flex';
    document.getElementById('mobile-proofs').style.display = 'flex';
  }
  renderProofs(); renderGhosts();
}

function resetGame() {
  if(confirm('R√©initialiser la chasse ?')) {
    state.inc = []; state.exc = []; state.manual = []; state.san = 100; state.search = ''; state.speedFilter = null;
    stopTimer(); stopMetronome();
    document.getElementById('search-input').value = '';
    const sanSlider = document.getElementById('san-slider');
    if(sanSlider) sanSlider.value = 100;
    setSan(100);
    renderProofs(); renderGhosts();
  }
}

function renderProofs() {
  const html = PROOFS.map(p => {
    let st = '';
    if(state.inc.includes(p.id)) st = 'data-state="inc"';
    if(state.exc.includes(p.id)) st = 'data-state="exc"';
    return `<button class="proof-btn" ${st} onclick="toggleProof('${p.id}')">${p.label}</button>`;
  }).join('');
  document.getElementById('mobile-proofs').innerHTML = html; 
  document.getElementById('pc-proofs-list').innerHTML = html.replace(/proof-btn/g, 'proof-btn sidebar-btn'); 
  if(state.difficulty === 'apoc') {
    document.getElementById('pc-proofs-list').style.display = 'none';
    document.getElementById('mobile-proofs').style.display = 'none';
  } else {
    document.getElementById('pc-proofs-list').style.display = 'flex';
    document.getElementById('mobile-proofs').style.display = 'flex';
  }
}

function toggleProof(id) {
  if(state.inc.includes(id)) { state.inc = state.inc.filter(x=>x!==id); state.exc.push(id); } 
  else if(state.exc.includes(id)) { state.exc = state.exc.filter(x=>x!==id); } 
  else { state.inc.push(id); }
  saveState(); renderProofs(); renderGhosts();
}

function filterSpeed(type) {
  state.speedFilter = (state.speedFilter === type) ? null : type;
  document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
  if(state.speedFilter) document.getElementById('btn-speed-'+type).classList.add('active');
  renderGhosts();
}

function highlightText(text, searchTerms) {
  if (!searchTerms || searchTerms.length === 0) return text;
  const regex = new RegExp(`(${searchTerms.join('|')})`, 'gi');
  return text.replace(regex, '<span class="highlight">$1</span>');
}

function renderGhosts() {
  const aiBox = document.getElementById('ai-suggestion');
  const aiText = document.getElementById('ai-text');
  let aiFound = false;
  let activeTokens = [];

  if(state.search) {
    const stopWords = ['le','la','les','un','une','des','il','elle','on','nous','vous','ils','elles','est','a','ont','sont','c\'est','dans','par','pour','en','vers','avec','sans','sous','sur','ne','pas','plus','moins','tr√®s','trop','peux','veut','fait'];
    const rawTokens = state.search.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").split(/[\s,'.]+/);
    activeTokens = rawTokens.filter(t => t.length > 2 && !stopWords.includes(t));

    const cleanSearch = state.search.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    for(let r of AI_RULES) {
      if(r.k.some(k => cleanSearch.includes(k))) {
        aiText.innerHTML = r.m; aiBox.classList.add('visible'); aiFound = true; break;
      }
    }
  }
  if(!aiFound) aiBox.classList.remove('visible');

  const FAST_GHOSTS = ['Djinn','Hantu','Jumeaux','Raiju','Mimic','Moroi','Deogen','Thaye','Revenant','Dayan','Gallu','Obambo'];
  const SLOW_GHOSTS = ['Revenant','Hantu','Jumeaux','Mimic','Moroi','Deogen','Thaye','Dayan','Gallu','Obambo'];

  const container = document.getElementById('ghost-grid');
  container.innerHTML = GHOSTS.map(g => {
    let gp = [...g.p]; if(g.n==='Mimic') gp.push('orb');
    
    const impossible = state.inc.some(id => !gp.includes(id));
    const excluded = state.exc.some(id => { if(g.n==='Mimic' && id==='orb') return false; return gp.includes(id); });
    
    let speedMatch = true;
    if(state.speedFilter === 'fast' && !FAST_GHOSTS.includes(g.n)) speedMatch = false;
    if(state.speedFilter === 'slow' && !SLOW_GHOSTS.includes(g.n)) speedMatch = false;
    if(state.speedFilter === 'normal' && (FAST_GHOSTS.includes(g.n) || SLOW_GHOSTS.includes(g.n))) speedMatch = false;

    const manuallyKilled = state.manual.includes(g.n);
    
    let searchMatch = true;
    if(activeTokens.length > 0) {
        const cleanDesc = g.d.replace(/<[^>]*>/g, ' ');
        const fullText = (g.n + ' ' + g.t + ' ' + cleanDesc).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const found = activeTokens.some(token => fullText.includes(token));
        if(!found) searchMatch = false;
    }

    if((impossible || excluded || !searchMatch || !speedMatch) && !manuallyKilled) return ''; 
    
    let cls = 'ghost candidate'; if(manuallyKilled) cls = 'ghost manual-excluded';

    const displayName = activeTokens.length ? highlightText(g.n, activeTokens) : g.n;
    const displayShort = activeTokens.length ? highlightText(g.t, activeTokens) : g.t;
    const displayDesc = activeTokens.length ? highlightText(g.d, activeTokens) : g.d;

    return `
      <div class="${cls}">
        <div class="g-head"><span class="g-name">${displayName}</span><span style="font-size:0.8rem; font-weight:bold; color:var(--accent)">${g.sp} m/s</span></div>
        <div class="g-meta">
          ${g.p.map(pid => {
            const lbl = PROOFS.find(x=>x.id===pid).label;
            const match = state.inc.includes(pid) ? 'match' : '';
            return `<span class="badge ${match}">${lbl}</span>`;
          }).join('')}
          ${g.n==='Mimic' ? '<span class="badge">Fake Orbe</span>' : ''}
        </div>
        <div style="font-size:0.85rem; color:#cbd5e1; margin-bottom:8px; line-height:1.4;">${displayShort}</div>
        <div class="g-actions">
          <button class="btn-action metro-btn" onclick="toggleGhostMetro('${g.sp}', this)">üîä</button>
          <button class="btn-action" style="flex:2" onclick="toggleDetails('${g.n}')">üìñ D√âTAILS</button>
          <button class="btn-action" onclick="toggleManual('${g.n}')">${manuallyKilled ? '‚Ü∫' : '‚ùå'}</button>
        </div>
        <div id="details-${g.n}" class="g-details ${activeTokens.length ? 'open' : ''}">${displayDesc}</div>
      </div>
    `;
  }).join('');
}

function toggleDetails(name) { document.getElementById('details-'+name).classList.toggle('open'); }
function toggleManual(name) { if(state.manual.includes(name)) state.manual = state.manual.filter(x=>x!==name); else state.manual.push(name); saveState(); renderGhosts(); }
function setSearch(val) { state.search = val; renderGhosts(); }

function toggleVoice() {
  const micBtn = document.getElementById('mic-btn');
  if (!('webkitSpeechRecognition' in window)) { alert("Utilisez Chrome/Edge"); return; }
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'fr-FR';
  recognition.onstart = () => { micBtn.classList.add('listening'); };
  recognition.onend = () => { micBtn.classList.remove('listening'); };
  recognition.onresult = (event) => {
    let transcript = event.results[0][0].transcript.toLowerCase();
    transcript = transcript
      .replace(/deo.*/g, 'deogen').replace(/taille|thai/g, 'thaye').replace(/jean|gin/g, 'djinn')
      .replace(/han tou|un tout/g, 'hantu').replace(/raichu|rail/g, 'raiju')
      .replace(/on y|au nid/g, 'oni').replace(/l'oeil|ok/g, 'yokai')
      .replace(/benchy/g, 'banshee').replace(/maillling/g, 'myling')
      .replace(/dayan|diane/g, 'dayan').replace(/gallu|galou/g, 'gallu').replace(/obambo|obama/g, 'obambo');
    document.getElementById('search-input').value = transcript;
    setSearch(transcript);
  };
  recognition.start();
}

function updateSpeed(val) {
  const sidebarVal = document.getElementById('speed-val-sidebar');
  const mobileVal = document.getElementById('speed-val-mobile');
  const sidebarSlider = document.getElementById('speed-slider-sidebar');
  const mobileSlider = document.getElementById('speed-slider-mobile');
  if(sidebarVal) sidebarVal.innerText = val;
  if(mobileVal) mobileVal.innerText = val;
  if(sidebarSlider) sidebarSlider.value = val;
  if(mobileSlider) mobileSlider.value = val;
}

function playCustomSpeed() {
  const val = document.getElementById('speed-slider-sidebar') ? document.getElementById('speed-slider-sidebar').value : 1.7;
  startMetronome(val, document.getElementById('btn-custom-play-sidebar'));
}

function toggleGhostMetro(speed, btn) {
  if(btn.classList.contains('active')) { stopMetronome(); return; }
  stopMetronome(); let v = parseFloat(speed) || 1.7; startMetronome(v, btn);
}

function startMetronome(speed, btn) {
  if(audioCtx.state === 'suspended') audioCtx.resume();
  stopMetronome(); if(btn) btn.classList.add('active');
  updateSpeed(speed);
  let delay = 600; if(speed > 0) delay = 1000 / (speed / 1.7 * 1.5);
  metroId = setInterval(() => {
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination); o.frequency.value = 800; g.gain.value = 0.1;
    o.start(); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1); o.stop(audioCtx.currentTime + 0.1);
  }, delay);
}

function stopMetronome() { clearInterval(metroId); document.querySelectorAll('.metro-btn, .btn-action, .sidebar-btn').forEach(b => b.classList.remove('active')); }

function tapBpm() {
  const now = Date.now(); 
  if(lastTap) { 
    const diff = (now - lastTap)/1000; const est = (1/diff)*1.1; 
    const t1 = document.getElementById('bpm-val-sidebar'); 
    const t2 = document.getElementById('bpm-val-mobile'); 
    if(t1) t1.innerText = est.toFixed(1); 
    if(t2) t2.innerText = est.toFixed(1); 
  }
  lastTap = now; setTimeout(() => { if(Date.now()-lastTap > 2000) lastTap=0; }, 2000);
}

function runTimer(s) {
  if(audioCtx.state === 'suspended') audioCtx.resume();
  clearInterval(tInterval); let t = s;
  const tick = () => { let m = Math.floor(t/60).toString().padStart(2,'0'); let sec = (t%60).toString().padStart(2,'0'); const t1=document.getElementById('timer-disp-sidebar'); const t2=document.getElementById('timer-disp-mobile'); if(t1) t1.innerText=`${m}:${sec}`; if(t2) t2.innerText=`${m}:${sec}`; };
  tick(); tInterval = setInterval(() => { t--; tick(); if(t<=0) { clearInterval(tInterval); const t1=document.getElementById('timer-disp-sidebar'); const t2=document.getElementById('timer-disp-mobile'); if(t1) t1.innerText="PRET"; if(t2) t2.innerText="PRET"; const o=audioCtx.createOscillator(); o.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.5); } }, 1000);
}

function stopTimer() { clearInterval(tInterval); document.getElementById('timer-disp-sidebar').innerText = "00:00"; document.getElementById('timer-disp-mobile').innerText = "00:00"; }

/* AUDIO ANALYZER LOGIC */
async function toggleAudioAnalyzer(mode) {
  if(audioAnalysing) {
    if(audioSource) audioSource.disconnect();
    audioAnalysing = false;
    document.getElementById('audio-viz-sidebar').classList.remove('active');
    document.getElementById('audio-viz-mobile').classList.remove('active');
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioSource = audioCtx.createMediaStreamSource(stream);
    audioAnalyzerNode = audioCtx.createAnalyser();
    audioAnalyzerNode.fftSize = 256;
    audioSource.connect(audioAnalyzerNode);
    audioAnalysing = true;
    document.getElementById('audio-viz-'+mode).classList.add('active');
    detectBeats(mode);
  } catch(e) { alert("Micro non d√©tect√©. V√©rifiez vos permissions."); }
}

function setAudioThreshold(val) { audioThreshold = val; }

function detectBeats(mode) {
  if(!audioAnalysing) return;
  const bufferLength = audioAnalyzerNode.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  audioAnalyzerNode.getByteFrequencyData(dataArray);
  
  let sum = 0; for(let i=0; i<bufferLength; i++) sum += dataArray[i];
  let average = sum / bufferLength;
  let val = (average / 255) * 100;
  
  const bar = document.getElementById('audio-bar-'+mode);
  const thresh = audioThreshold * 0.8; // scaling
  
  if(bar) {
    bar.style.width = Math.min(val * 3, 100) + '%';
    if(val > thresh) {
      bar.classList.add('peak');
      const now = Date.now();
      if(now - lastPeakTime > 250) { // Debounce 250ms
        if(lastPeakTime !== 0) {
          const diff = (now - lastPeakTime) / 1000;
          beatTimes.push(diff);
          if(beatTimes.length > 4) beatTimes.shift();
          
          let avgDiff = beatTimes.reduce((a,b)=>a+b,0) / beatTimes.length;
          let bpm = Math.round(60 / avgDiff);
          let speed = (1.7 * (bpm / 115)).toFixed(1); // Calibration approx
          
          document.getElementById('audio-bpm-'+mode).innerText = bpm;
          document.getElementById('audio-speed-'+mode).innerText = speed;
        }
        lastPeakTime = now;
      }
    } else {
      bar.classList.remove('peak');
    }
  }
  requestAnimationFrame(() => detectBeats(mode));
}

function loadLocs(key) { const div = document.getElementById('loc-area'); if(!key) { div.innerHTML=''; return; } const data = LOCATIONS[key] || []; div.innerHTML = data.map(i => `<div style="padding:10px; border-bottom:1px solid #333"><b>${i.i} ${i.n}</b><br><span style="color:#94a3b8">${i.l}</span></div>`).join(''); }

function setSan(v) { state.san = v; document.getElementById('san-disp').innerText = v+"%"; saveState(); }
function saveState() { localStorage.setItem('phasmo_v21', JSON.stringify(state)); }
function loadState() { const s = localStorage.getItem('phasmo_v21'); if(s) { state = JSON.parse(s); if(document.getElementById('diff-select')) document.getElementById('diff-select').value = state.difficulty || 'ama'; } }

init();
</script>
</body>
</html>
